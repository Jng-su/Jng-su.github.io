---
title: âš¡ FastAPI - User API
date: 2024-06-22 00:00:00 +0800
toc: true
pin: false
published: true
categories: [SERVER, FASTAPI]
tags: [fastapi]
image: https://github.com/Jng-su/Jng-su/assets/168960634/22fbcb9b-a69d-4154-9519-07c66b8a7681
---

<br>

---

> ## Hash


<br>

ë³´ì•ˆìƒ DBì— ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸í™”ë˜ì§€ ì•Šì€ í‰ë¬¸(Plaintext)ì„ ì €ì¥í•˜ë©´ ì•ˆë¨. ğŸ¤ ê·¸ë˜ì„œ í•„ìš”í•œ ê³¼ì •ì´ í•´ì‹œí™”ëœ ì•”í˜¸ë¬¸(Encrypt)ì„ ì €ì¥í•˜ê³  ë¡œê·¸ì¸ ì‹œ ì´ë¥¼ ë³µí˜¸í™”(Decrypt) í•˜ë©´ë¨

FastAPI ì—ì„œ ì œê³µí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

```shell
pip install passlib[bcrypt]
```

ì´ëŠ” bcrypt ì•”í˜¸í™”ë¥¼ ì œê³µí•˜ì—¬ DBì— ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ê²Œí•¨.

<br>

### CryptContext

Passlib ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ë¡œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹±í•˜ê³  ë¡œê·¸ì¸ì‹œ ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ì™€ DBì— ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸(hashed_password)ì™€ ë¹„êµ ê²€ì¦í•  ìˆ˜ ìˆìŒ

<br>

`app.Utils.hashing.py`

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

<br>

```python
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
```

- `schemes=["bcrypt"]` : CryptContextê°€ ì‚¬ìš©í•  ì•Œê³ ë¦¬ì¦˜ ì§€ì • (bcrypt)
- `deprecated="auto"` : Passlibê°€ íê¸°ëœ í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬. ìµœì‹  ë³´ì•ˆ ê¶Œì¥ ì‚¬í•­ì— ë”°ë¼ í•´ì‹±ì„ ê´€ë¦¬

<br>

> ## Sign In/Up

### Sign Up

ìš°ì„  ìœ íš¨ì„± ê²€ì‚¬ì™€ ì´ë©”ì¼ ë° ë‹‰ë„¤ì„ ì¤‘ë³µ ê²€ì‚¬ëŠ” ì œì¹˜ê³  ì‘ì„±í•¨.


`app.Services.cash_service.py`

```python
# Signup user
def signup_user(user: user_model.UserCreate, db: Session) -> user_model.User:
    return user_dao.create_user(db, email=user.email, nickname=user.nickname, password=hashing.hash_password(user.password))
```

<br>

`app.Services.dao.cash_dao.py`

```python
def get_user_by_email(db: Session, user_email: str) -> user_model.User:
    stmt = select(user_model.User).where(user_model.User.email == user_email)
    return db.exec(stmt).one_or_none()

def create_user(db: Session, email: str, nickname: str, password: str) -> user_model.User:
    stmt = insert(user_model.User).values(email=email, nickname=nickname, password=password)
    db.exec(stmt)
    db.commit()
    return get_user_by_email(db, email)
```

- `get_user_by_email` ì€ ê³µí†µ ëª¨ë“ˆë¡œ ë¶„ë¦¬í•˜ê³  (ê·¸ë˜ì„œ daoë¡œ ë”°ë¡œ ì‘ì„±) return ê°’ì„ create_user í•œ í›„ ìƒì„±ëœ ìœ ì €ì˜ Formì„ return í•œë‹¤.

![image](https://github.com/Jng-su/Jng-su/assets/168960634/7b48d801-f42f-4475-bb38-4ff5d1c7bd75)

Hashingí•˜ê¸° ì „ í›„ ì°¨ì´ ğŸ‘

(ìœ íš¨ì„± ë° ì¤‘ë³µ ê²€ì‚¬ëŠ” ë‚˜ì¤‘ì— í¬ìŠ¤íŠ¸í•¨)

<br>

### Sign In

ë¡œê·¸ì¸ ì‹œ ê°€ì¥ ë¨¼ì € ìƒê°ë‚˜ëŠ”ê²Œ JWT

JWT(Json Web Token)ëŠ” Json ê°ì²´ì— ì¸ì¦ì— í•„ìš”í•œ ì •ë³´ë“¤ì„ ë‹´ì•„ ì¸ì¦(Authentication)ê³¼ í—ˆê°€(Authorization) ë°©ì‹ì—ì„œ ì‚¬ìš©ëœë‹¤.

![jwt](https://github.com/Jng-su/Jng-su/assets/168960634/9fb76c54-d24d-40ac-8b7b-59678b58e513){: width="500" height="500"}

ìš°ì„  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜

```shell
pip install pyjwt
```

[https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/](https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/)

```python

```