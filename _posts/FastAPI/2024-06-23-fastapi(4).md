---
title: âš¡ FastAPI | User API
date: 2024-06-22 00:00:00 +0800
toc: true
pin: false
published: true
categories: [SERVER, FASTAPI]
tags: [fastapi]
image: https://github.com/Jng-su/Jng-su/assets/168960634/22fbcb9b-a69d-4154-9519-07c66b8a7681
---

<br>

---

> ## Hash


<br>

ë³´ì•ˆìƒ DBì— ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸í™”ë˜ì§€ ì•Šì€ í‰ë¬¸(Plaintext)ì„ ì €ì¥í•˜ë©´ ì•ˆë¨. ğŸ¤ ê·¸ë˜ì„œ í•„ìš”í•œ ê³¼ì •ì´ í•´ì‹œí™”ëœ ì•”í˜¸ë¬¸(Encrypt)ì„ ì €ì¥í•˜ê³  ë¡œê·¸ì¸ ì‹œ ì´ë¥¼ ë³µí˜¸í™”(Decrypt) í•˜ë©´ë¨

FastAPI ì—ì„œ ì œê³µí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

```shell
pip install passlib[bcrypt]
```

ì´ëŠ” bcrypt ì•”í˜¸í™”ë¥¼ ì œê³µí•˜ì—¬ DBì— ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ê²Œí•¨.

<br>

### CryptContext

Passlib ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ë¡œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹±í•˜ê³  ë¡œê·¸ì¸ì‹œ ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ì™€ DBì— ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸(hashed_password)ì™€ ë¹„êµ ê²€ì¦í•  ìˆ˜ ìˆìŒ

<br>

#### ğŸ“Ÿ `app.Utils.hashing.py`

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

<br>

```python
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
```

- `schemes=["bcrypt"]` : CryptContextê°€ ì‚¬ìš©í•  ì•Œê³ ë¦¬ì¦˜ ì§€ì • (bcrypt)
- `deprecated="auto"` : Passlibê°€ íê¸°ëœ í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬. ìµœì‹  ë³´ì•ˆ ê¶Œì¥ ì‚¬í•­ì— ë”°ë¼ í•´ì‹±ì„ ê´€ë¦¬

<br>

#### ğŸ“Ÿ `app.Services.user_service.py`

```python
import app.Utils.hashing as hashing

# Signup user
def signup_user(user: user_model.UserCreate, db: Session) -> user_model.User:
    return user_dao.create_user(db, email=user.email, nickname=user.nickname, password=hashing.hash_password(user.password))
```

<br>

> ## User API

### Sign Up

ìš°ì„  ìœ íš¨ì„± ê²€ì‚¬ì™€ ì´ë©”ì¼ ë° ë‹‰ë„¤ì„ ì¤‘ë³µ ê²€ì‚¬ëŠ” ì œì¹˜ê³  ì‘ì„±í•¨.


#### ğŸ“Ÿ `app.Services.user_service.py`

```python
# Signup user
def signup_user(user: user_model.UserCreate, db: Session) -> user_model.User:
    return user_dao.create_user(db, email=user.email, nickname=user.nickname, password=hashing.hash_password(user.password))
```

<br>

#### ğŸ“Ÿ `app.Services.dao.user_dao.py`

```python
def get_user_by_email(db: Session, user_email: str) -> user_model.User:
    stmt = select(user_model.User).where(user_model.User.email == user_email)
    return db.exec(stmt).one_or_none()

def create_user(db: Session, email: str, nickname: str, password: str) -> user_model.User:
    stmt = insert(user_model.User).values(email=email, nickname=nickname, password=password)
    db.exec(stmt)
    db.commit()
    return get_user_by_email(db, email)
```

- `get_user_by_email` ì€ ê³µí†µ ëª¨ë“ˆë¡œ ë¶„ë¦¬í•˜ê³  (ê·¸ë˜ì„œ daoë¡œ ë”°ë¡œ ì‘ì„±) return ê°’ì„ create_user í•œ í›„ ìƒì„±ëœ ìœ ì €ì˜ Formì„ return í•œë‹¤.

![image](https://github.com/Jng-su/Jng-su/assets/168960634/7b48d801-f42f-4475-bb38-4ff5d1c7bd75)

Hashingí•˜ê¸° ì „ í›„ ì°¨ì´ ğŸ‘

(ìœ íš¨ì„± ë° ì¤‘ë³µ ê²€ì‚¬ëŠ” ë‚˜ì¤‘ì— í¬ìŠ¤íŠ¸í•¨)

<br>

### Sign In

ë¡œê·¸ì¸ ì‹œ ê°€ì¥ ë¨¼ì € ìƒê°ë‚˜ëŠ”ê²Œ JWT

JWT(Json Web Token)ëŠ” Json ê°ì²´ì— ì¸ì¦ì— í•„ìš”í•œ ì •ë³´ë“¤ì„ ë‹´ì•„ ì¸ì¦(Authentication)ê³¼ í—ˆê°€(Authorization) ë°©ì‹ì—ì„œ ì‚¬ìš©ëœë‹¤.

![jwt](https://github.com/Jng-su/Jng-su/assets/168960634/9fb76c54-d24d-40ac-8b7b-59678b58e513){: width="500" height="500"}

ìš°ì„  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜

```shell
pip install pyjwt
```

[https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/](https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/)

ìœ„ ê³µì‹ë¬¸ì„œì—ì„œ SECRET_KEY ë¥¼ ìƒì„±í•¨.

```python
openssl rand -hex 32
```

<br>

`.env`

```
JWT_SECRET_KEY = e992d48e2fa39451b00a91ece7d6e421e48d9050ae3968428e5ac2bb1e32d059
ALGORITHM = HS256
```

- ìƒì„±ëœ hexê°’ì„ `JWT_SECRET_KEY`ì— ë„£ì–´ì¤Œ
- `ALGORITHM`ì€ ì›í•˜ëŠ” ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ ë„£ì–´ì£¼ë©´ëŒ.

<br>

```shell
pip install dotenv
```

ê·¸ë¦¬ê³  ë­í–ˆë”ë¼ ê¸°ì–µì´ ì˜ ì•ˆë‚˜ë„¤ ğŸ˜…

<br>

```python
from dotenv import load_dotenv

import os, jwt

# Load env file
load_dotenv(".env")
JWT_SECRET_KEY = os.getenv("JWT_SECRET_KEY")
ALGORITHM = os.getenv("ALGORITHM")
```

ì´ëŸ¬ë©´ JWT encode, decodeìš© importëŠ” ì™„ë£Œí–ˆìŒ.

<br>

#### ğŸ“Ÿ `app.Routers.user_router.py`

```python
# POST /api/user/signin
@user_router.post("/user/signin", response_model=user_model.UserToken)
def signin_user(user: user_model.UserLogin, db: Session = Depends(get_db)):
    return user_service.signin_user(user, db)
```

ì´ê±¸ ë§Œë“¤ê±°ì„. ì´ê±´ ë°”ë¡œë°”ë¡œ ë¬´ë ¤ ëŒ€ë§ì˜ ì§„ì§œ ë¦¬ì–¼ë¡œ **"ë¡œê·¸ì¸"**ì„ ğŸ‘€

<br>

#### ğŸ“Ÿ `app.Services.user_service.py`

```python
# Signin user
def signin_user(user: user_model.UserLogin, db: Session) -> user_model.UserToken:
    user = user_dao.get_user_by_email(db, user.email)
    access_token = user_dao.create_token(data={"sub": user.email}, expires_delta=timedelta(minutes=60))
    refresh_token = user_dao.create_token(data={"sub": user.email}, expires_delta=timedelta(days=30))
    return user_model.UserToken(token_type="bearer", access_token=access_token, refresh_token=refresh_token)
```

ì„¤ëª…í•˜ê² ìŒ. ì‚¬ì‹¤ ë‚˜ë„ ì˜ ëª¨ë¦„. Docsë³´ê³  ë§Œë“¦

[https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/#update-the-dependencies](https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/#update-the-dependencies)

- ë»¥ì´ê³ , ìš°ì„  `user` ê°€ ì¡´ì¬í•˜ëŠ” ì§€ íŒë‹¨í•´ì•¼í•¨.
  - ê·¸ëŸ¬ê¸° ìœ„í•´ì„œ Loginì‹œ ì‚¬ìš©í•œ emailì„ ë³´ê³  daoì—ì„œ ì¡°íšŒí•˜ê³  ì—†ìœ¼ë©´ `HTTPException` ìœ¼ë¡œ ì—ëŸ¬ì²˜ë¦¬í•¨.
- Access_tokenê³¼ Refresh_tokenì„ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ê´€ë¦¬
- `data={"sub": user.email}` : JWT ì„ ìƒì„±í•  ë•Œ ì‚¬ìš©ë˜ëŠ” ë°ì´í„° íƒ€ì…
  - ì‚¬ìš©ëœ `user.email` ì€ JWTì˜ ì£¼ì²´ì´ê³  email í˜¹ì€ id ê°’ ì‚¬ìš©

<br>

#### ğŸ“Ÿ `app.Services.dao.user_dao.py`

```python
# Create access and refresh token
def create_token(data: dict, expires_delta: timedelta) -> str:
    to_encode = data.copy()
    expire = datetime.now() + expires_delta
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, JWT_SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt
```

![image](https://github.com/Jng-su/Jng-su/assets/168960634/a7b39203-8186-4a7f-a114-34a58f422abf)