---
title: ⚡ FastAPI - User API
date: 2024-06-22 00:00:00 +0800
toc: true
pin: false
published: true
categories: [SERVER, FASTAPI]
tags: [fastapi]
image: https://github.com/Jng-su/Jng-su/assets/168960634/22fbcb9b-a69d-4154-9519-07c66b8a7681
---

<br>

---

> ## Hash


<br>

보안상 DB에 사용자 비밀번호를 암호화되지 않은 평문(Plaintext)을 저장하면 안됨. 🤐 그래서 필요한 과정이 해시화된 암호문(Encrypt)을 저장하고 로그인 시 이를 복호화(Decrypt) 하면됨

FastAPI 에서 제공하는 라이브러리

```shell
pip install passlib[bcrypt]
```

이는 bcrypt 암호화를 제공하여 DB에 안전하게 저장하게함.

<br>

### CryptContext

Passlib 라이브러리에서 제공하는 클래스로 비밀번호 해싱하고 로그인시 입력된 비밀번호와 DB에 저장된 비밀번호(hashed_password)와 비교 검증할 수 있음

<br>

`app.Utils.hashing.py`

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

<br>

```python
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
```

- `schemes=["bcrypt"]` : CryptContext가 사용할 알고리즘 지정 (bcrypt)
- `deprecated="auto"` : Passlib가 폐기된 해싱 알고리즘을 자동으로 처리. 최신 보안 권장 사항에 따라 해싱을 관리

<br>

> ## Sign In/Up

### Sign Up

우선 유효성 검사와 이메일 및 닉네임 중복 검사는 제치고 작성함.


`app.Services.cash_service.py`

```python
# Signup user
def signup_user(user: user_model.UserCreate, db: Session) -> user_model.User:
    return user_dao.create_user(db, email=user.email, nickname=user.nickname, password=hashing.hash_password(user.password))
```

<br>

`app.Services.dao.cash_dao.py`

```python
def get_user_by_email(db: Session, user_email: str) -> user_model.User:
    stmt = select(user_model.User).where(user_model.User.email == user_email)
    return db.exec(stmt).one_or_none()

def create_user(db: Session, email: str, nickname: str, password: str) -> user_model.User:
    stmt = insert(user_model.User).values(email=email, nickname=nickname, password=password)
    db.exec(stmt)
    db.commit()
    return get_user_by_email(db, email)
```

- `get_user_by_email` 은 공통 모듈로 분리하고 (그래서 dao로 따로 작성) return 값을 create_user 한 후 생성된 유저의 Form을 return 한다.

![image](https://github.com/Jng-su/Jng-su/assets/168960634/7b48d801-f42f-4475-bb38-4ff5d1c7bd75)

Hashing하기 전 후 차이 👍

(유효성 및 중복 검사는 나중에 포스트함)

<br>

### Sign In

로그인 시 가장 먼저 생각나는게 JWT

JWT(Json Web Token)는 Json 객체에 인증에 필요한 정보들을 담아 인증(Authentication)과 허가(Authorization) 방식에서 사용된다.

![jwt](https://github.com/Jng-su/Jng-su/assets/168960634/9fb76c54-d24d-40ac-8b7b-59678b58e513){: width="500" height="500"}

우선 라이브러리를 설치

```shell
pip install pyjwt
```

[https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/](https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/)

```python

```