---
title: âš¡ FastAPI - Cashbook CRUD
date: 2024-06-21 00:00:00 +0800
toc: true
pin: false
published: true
categories: [SERVER, FASTAPI]
tags: [fastapi]
image: https://github.com/Jng-su/Jng-su/assets/168960634/22fbcb9b-a69d-4154-9519-07c66b8a7681
---

<br>

---

<br>


> ## Database Models

### ğŸ“Ÿ `.app.Models.cash_model.py`

```python 
from sqlmodel import Field, SQLModel

# ê³µí†µ ì†ì„±ì„ ì •ì˜í•˜ëŠ” ê¸°ë³¸ ëª¨ë¸ í´ë˜ìŠ¤, DBì˜ ì—”í‹°í‹°
class CashBase(SQLModel):
    date: str
    description: str
    income: int
    outcome: int

# ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” (CashBaseë¥¼ ìƒì†ë°›ìŒ), ORM ëª¨ë¸
class Cash(CashBase, table=True):
    __tablename__ = "cash"

    id: int = Field(default=None, primary_key=True)

class CashCreate(CashBase):
    pass

# ì—¬ëŸ¬ Cash ë¦¬ìŠ¤íŠ¸ì™€ ì´ income, outcome ê°’ì„ í¬í•¨
class CashbookListResponse(SQLModel):
    cashbooks: list[Cash]
    income: int
    outcome: int
```

- `CashBase`ì™€ `Cash`ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ í´ë˜ìŠ¤ëŠ” DTOë¼ê³  ìƒê°í•˜ë©´ í¸í•¨
- `CashbookListResponse`ì—ì„œ CashBaseë¥¼ ìƒì†ë°›ì§€ ì•Šê³  `income` ê³¼ `outcome`ì„ ì •ì˜í•˜ëŠ” ì´ìœ ëŠ” ì—¬ê¸°ì„  ì´ ìˆ˜ìµê³¼ ìˆ˜ì¶œì„ ê³„ì‚°í•˜ê¸° ìœ„í•¨ì„.
- ì‹œê°„ ë‚˜ë©´ DTOë„ ë¶„ë¦¬í•´ë´ì•¼ê² ìŒ ğŸ˜Š

<br>

> ## Import

### Routers

#### ğŸ“Ÿ `.app.Routers.__init__.py`

í•˜ë‚˜ì˜ íŒŒì¼ì—ì„œ ì—¬ëŸ¬ê°œì˜ ë¼ìš°í„°ë“¤ì„ import í•˜ì—¬ `main` ì—ì„œ í•œ ë²ˆì— ì‚¬ìš©í•˜ê¸° ìœ„í•¨ì„

```python
from fastapi import APIRouter
from app.Routers.cash_router import cash_router

routers = APIRouter()

routers.include_router(cash_router, prefix="/api")
```

<br>

#### ğŸ“Ÿ `.app.Routers.cash_router.py`

ìš°ì„  í•„ìš”í•œ ê²ƒë“¤ì„ import

```python
from fastapi import APIRouter, Depends, HTTPException
from sqlmodel import Session
from database import get_db

import app.Models.cash_model as cash_model
import app.Services.cash_service as cash_service

cash_router = APIRouter(tags=["Cash"])
```



<br>

### Services

#### ğŸ“Ÿ `.app.Services.cash_service.py`

ìš°ì„  í•„ìš”í•œ ê²ƒë“¤ì„ import

```python
from sqlmodel import Session, select, insert, update, delete, desc, func

import app.Models.cash_model as cash_model
```

<br>

> ## Cardbook CRUD

### Create

#### ğŸ“Ÿ `.app.Routers.cash_router.py`

```python
# Create cashbook
@cash_router.post("/cashbook", response_model=cash_model.Cash)
def post_cashbook(cashbook: cash_model.CashCreate, db: Session = Depends(get_db)):
    new_cashbook = cash_service.post_cashbook(cashbook, db)
    if new_cashbook is None:
        raise HTTPException(status_code=400, detail="Something went wrong")
    return new_cashbook
```

ë³¸ì¸ì€ í•­ìƒ postìš”ì²­ì„ ê°€ì¥ ë¨¼ì € êµ¬í˜„í•¨ âœŒï¸

- `response_model=cash_model.Cash` : í•¨ìˆ˜ê°€ ì™„ë£Œëœ í›„ ë°˜í™˜í•  ë°ì´í„° í˜•ì‹ì„ ë‚˜íƒ€ëƒ„. 
- `cashbook: cash_model.CashCreate` : Createí•  ë•Œ ì •ì˜í•œ DTOë¥¼ ì‚¬ìš©í•¨
- `Session` : SQLAlchemyì—ì„œ ì œê³µí•˜ëŠ” DB ì„¸ì…˜ ê°ì²´
- `Depends(get_db)` : ìœ„ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë©´ DB ì„¸ì…˜ ê°ì²´ê°€ ìƒì„±

<br>

#### ğŸ“Ÿ `.app.Services.cash_service.py`

```python
# Create cashbook
def post_cashbook(cashbook: cash_model.CashCreate, db: Session) -> cash_model.Cash | None:
    stmt = insert(cash_model.Cash).values(
        date=cashbook.date,
        description=cashbook.description,
        income=cashbook.income,
        outcome=cashbook.outcome
    )
    result = db.exec(stmt)
    db.commit()
    cashbook_id = result.inserted_primary_key[0]
    new_cashbook = db.exec(select(cash_model.Cash).where(cash_model.Cash.id == cashbook_id)).one_or_none()
    return new_cashbook
```

- `cashbook: cash_model.CashCreate` : í´ë¼ì´ì–¸íŠ¸ â¡ï¸ ì„œë²„ == Request
- `-> cash_model.Cash` : ì„œë²„ â¡ï¸ í´ë¼ì´ì–¸íŠ¸ == Response

<br>

### Read

í¬ê²Œ ë‘ ê°€ì§€ë¡œ ë‚˜ëˆŒ ì˜ˆì •

1. `id` ê°’ìœ¼ë¡œ íŠ¹ì • cashbookë¥¼ ì¡°íšŒí•˜ê¸°
2. ëª¨ë“  cashbooksë¥¼ ì¡°íšŒí•˜ê¸°. ë‹¨, ë‚ ì§œë³„ë¡œ ì¡°íšŒë„ ê°€ëŠ¥í•˜ê²Œ

<br>

#### ğŸ“Ÿ `.app.Routers.cash_router.py`

```python
# Read cashbook by id
@cash_router.get("/cashbook/{cashbook_id}", response_model=cash_model.Cash)
def get_cashbook(cashbook_id: int, db: Session = Depends(get_db)):
    return cash_service.get_cashbook(cashbook_id, db)

# Read all cashbooks or by date
@cash_router.get("/cashbook", response_model=cash_model.CashbookListResponse)
def get_cashbooks(db: Session = Depends(get_db), start_date: str = '', end_date: str = ''):
    return cash_service.get_cashbooks(db, start_date, end_date)
```

<br>

#### ğŸ“Ÿ `.app.Services.cash_service.py`

```python
# Get cashbook
def get_cashbook(cashbook_id: int, db: Session) -> cash_model.Cash | None:
    return db.exec(select(cash_model.Cash).where(cash_model.Cash.id == cashbook_id)).one_or_none()


# Get cashbooks
def get_cashbooks(db: Session, start_date: str = '', end_date: str = '') -> cash_model.CashbookListResponse:
    # Get cashbooks by date
    if (start_date != '' and end_date != ''):
        cashbooks: list[cash_model.Cash] = db.exec(select(cash_model.Cash).where(cash_model.Cash.date.between(start_date, end_date)).order_by(desc(cash_model.Cash.id))).all()
    # Get all cashbooks
    else:
        cashbooks: list[cash_model.Cash] = db.exec(select(cash_model.Cash).where().order_by(desc(cash_model.Cash.id))).all()
    stmt = select(func.count(cash_model.Cash.id), func.sum(cash_model.Cash.income), func.sum(cash_model.Cash.outcome)).select_from(cash_model.Cash)
    result = db.exec(stmt).one()
    count, income, outcome = result
    return cash_model.CashbookListResponse(
        cashbooks=cashbooks, totalMoney=cash_model.TotalMoney(income=income, outcome=outcome, count=count),
    )
```

<br>

### Update

#### ğŸ“Ÿ `.app.Routers.cash_router.py`

```python
# Update cashbook
@cash_router.put("/cashbook/{cashbook_id}", response_model=cash_model.Cash)
def update_cashbook(cashbook_id: int, cashbook: cash_model.CashUpdate, db: Session = Depends(get_db)):
    return cash_service.update_cashbook(cashbook_id, cashbook, db)
```

<br>

#### ğŸ“Ÿ `.app.Services.cash_service.py`

```python
# Update cashbook
def update_cashbook(cashbook_id: int, cashbook: cash_model.CashUpdate, db: Session) -> cash_model.Cash | None:
    target_cashbook = db.exec(select(cash_model.Cash).where(cash_model.Cash.id == cashbook_id)).one_or_none()
    if target_cashbook is None:
        raise HTTPException(status_code=404, detail="Cashbook not found")
    
    stmt = update(cash_model.Cash).where(cash_model.Cash.id == cashbook_id).values(
        date=cashbook.date,
        description=cashbook.description,
        income=cashbook.income,
        outcome=cashbook.outcome
    )
    db.exec(stmt)
    db.commit()
    return db.exec(select(cash_model.Cash).where(cash_model.Cash.id == cashbook_id)).one_or_none()
```

<br>

### Delete

#### ğŸ“Ÿ `.app.Routers.cash_router.py`

```python
# Delete cashbook
@cash_router.delete("/cashbook/{cashbook_id}")
def delete_cashbook(cashbook_id: int, db: Session = Depends(get_db)):
    return cash_service.delete_cashbook(cashbook_id, db)
```

<br>

#### ğŸ“Ÿ `.app.Services.cash_service.py`

```python
# Delete cashbook
def delete_cashbook(cashbook_id: int, db: Session) -> cash_model.Cash | None:
    target_cashbook = db.exec(select(cash_model.Cash).where(cash_model.Cash.id == cashbook_id)).one_or_none()
    if target_cashbook is None:
        raise HTTPException(status_code=404, detail="Cashbook not found")
    stmt = delete(cash_model.Cash).where(cash_model.Cash.id == cashbook_id)
    db.exec(stmt)
    db.commit()
    return target_cashbook
```

<br>