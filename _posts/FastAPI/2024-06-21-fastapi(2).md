---
title: âš¡ FastAPI Connect DB & Simple CRUD
date: 2024-06-20 00:00:00 +0800
toc: true
pin: false
published: true
categories: [SERVER, FASTAPI]
tags: [fastapi]
image: https://github.com/Jng-su/Jng-su/assets/168960634/22fbcb9b-a69d-4154-9519-07c66b8a7681
---

<br>

---

> ## Folder Structure

<br>

```
server/
â”œâ”€â”€ main.py
â”œâ”€â”€ database.py
â”œâ”€â”€ database.db
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â”œâ”€â”€ cash_model.py
â”‚   â”œâ”€â”€ Routers/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ cash_router.py
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ cash_service.py
```

<br>

> ## Database

<br>

```shell 
pip install sqlmodel
```

<br>

### `.database.py`

```python
from sqlmodel import create_engine, SQLModel, Session

SQLALCHEMY_DATABASE_URL = "sqlite:///database.db"
engine = create_engine(SQLALCHEMY_DATABASE_URL, echo=True)
def create_db_and_tables():
    SQLModel.metadata.create_all(engine)

# SQLAlchemy ì—”ì§„ê³¼ì˜ ì—°ê²°ì„ í†µí•´ DB ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ë°˜í™˜í•¨
def get_db():
    db = Session(bind=engine, autocommit=False, autoflush=False)
    try:
        yield db
    finally:
        db.close()
```

<br>

### `.main.py`

```python
from database import engine
from sqlmodel import SQLModel
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.Routers import routers

# Create database tables
SQLModel.metadata.create_all(engine)

# Create FastAPI app instance
app = FastAPI()

# CORS settings
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],    # ëª¨ë“  í¬íŠ¸ í—ˆìš©
    allow_credentials=True, # ìê²© ì¦ëª… í—ˆìš©
    allow_methods=["*"],    # ëª¨ë“  HTTP method í—ˆìš©
    allow_headers=["*"],    # ëª¨ë“  HTTP header í—ˆìš©
)

app.include_router(routers)
```

- `SQLModel.metadata.create_all(engine)` : SQLAlchemyì˜ `create_all` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ëª¨ë“  í…Œì´ë¸”ì„ ìƒì„±í•¨
  - `SQLModel` ì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ëœ MetaData ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ DB ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•˜ê³  DBì— í…Œì´ë¸”ì„ ìƒì„±í•¨
  - `create_all(engine)` ì€ DBì™€ì˜ ì—°ê²°ì„ ê´€ë¦¬í•˜ê³  í…Œì´ë¸”ì´ ì¡´ì¬í•˜ë©´ ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ.

<br>

> ## Cardbook CRUD

<br>

### 1. Models

#### `.app.Models.cash_model.py`

```python 
from sqlmodel import Field, SQLModel

# ê³µí†µ ì†ì„±ì„ ì •ì˜í•˜ëŠ” ê¸°ë³¸ ëª¨ë¸ í´ë˜ìŠ¤, DBì˜ ì—”í‹°í‹°
class CashBase(SQLModel):
    date: str
    description: str
    income: int
    outcome: int

# ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” (CashBaseë¥¼ ìƒì†ë°›ìŒ), ORM ëª¨ë¸
class Cash(CashBase, table=True):
    __tablename__ = "cash"

    id: int = Field(default=None, primary_key=True)

class CashCreate(CashBase):
    pass

# ì—¬ëŸ¬ Cash ë¦¬ìŠ¤íŠ¸ì™€ ì´ income, outcome ê°’ì„ í¬í•¨
class CashbookListResponse(SQLModel):
    cashbooks: list[Cash]
    income: int
    outcome: int
```

- `CashBase`ì™€ `Cash`ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ í´ë˜ìŠ¤ëŠ” DTOë¼ê³  ìƒê°í•˜ë©´ í¸í•¨
- `CashbookListResponse`ì—ì„œ CashBaseë¥¼ ìƒì†ë°›ì§€ ì•Šê³  `income` ê³¼ `outcome`ì„ ì •ì˜í•˜ëŠ” ì´ìœ ëŠ” ì—¬ê¸°ì„  ì´ ìˆ˜ìµê³¼ ìˆ˜ì¶œì„ ê³„ì‚°í•˜ê¸° ìœ„í•¨ì„.
- ì‹œê°„ ë‚˜ë©´ DTOë„ ë¶„ë¦¬í•´ë´ì•¼ê² ìŒ ğŸ˜Š

<br>

### 2. Routers

#### `.app.Routers.__init__.py`

í•˜ë‚˜ì˜ íŒŒì¼ì—ì„œ ì—¬ëŸ¬ê°œì˜ ë¼ìš°í„°ë“¤ì„ import í•˜ì—¬ `main` ì—ì„œ í•œ ë²ˆì— ì‚¬ìš©í•˜ê¸° ìœ„í•¨ì„

```python
from fastapi import APIRouter
from app.Routers.cash_router import cash_router

routers = APIRouter()

routers.include_router(cash_router, prefix="/api")
```

<br>

#### `.app.Routers.cash_router.py`

ìš°ì„  í•„ìš”í•œ ê²ƒë“¤ì„ import

```python
from fastapi import APIRouter, Depends, HTTPException
from sqlmodel import Session
from database import get_db

import app.Models.cash_model as cash_model
import app.Services.cash_service as cash_service

cash_router = APIRouter(tags=["Cash"])
```

<br>

```python
# Create cashbook
@cash_router.post("/cashbook", response_model=cash_model.Cash)
def post_cashbook(cashbook: cash_model.CashCreate, db: Session = Depends(get_db)):
    new_cashbook = cash_service.post_cashbook(cashbook, db)
    if new_cashbook is None:
        raise HTTPException(status_code=400, detail="Something went wrong")
    return new_cashbook
```

ë³¸ì¸ì€ í•­ìƒ postìš”ì²­ì„ ê°€ì¥ ë¨¼ì € êµ¬í˜„í•¨ âœŒï¸

- `response_model=cash_model.Cash` : í•¨ìˆ˜ê°€ ì™„ë£Œëœ í›„ ë°˜í™˜í•  ë°ì´í„° í˜•ì‹ì„ ë‚˜íƒ€ëƒ„. 
- `cashbook: cash_model.CashCreate` : Createí•  ë•Œ ì •ì˜í•œ DTOë¥¼ ì‚¬ìš©í•¨
- `Session` : SQLAlchemyì—ì„œ ì œê³µí•˜ëŠ” DB ì„¸ì…˜ ê°ì²´
- `Depends(get_db)` : ìœ„ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë©´ DB ì„¸ì…˜ ê°ì²´ê°€ ìƒì„±

<br>

### 3. Services

#### `.app.Services.cash_service.py`

ìš°ì„  í•„ìš”í•œ ê²ƒë“¤ì„ import

```python
from sqlmodel import Session, select, insert, update, delete, desc, func

import app.Models.cash_model as cash_model
```

<br>

```python
# Create cashbook
def post_cashbook(cashbook: cash_model.CashCreate, db: Session) -> cash_model.Cash | None:
    stmt = insert(cash_model.Cash).values(
        date=cashbook.date,
        description=cashbook.description,
        income=cashbook.income,
        outcome=cashbook.outcome
    )
    result = db.exec(stmt)
    db.commit()
    cashbook_id = result.inserted_primary_key[0]
    new_cashbook = db.exec(select(cash_model.Cash).where(cash_model.Cash.id == cashbook_id)).one_or_none()
    return new_cashbook
```