---
title: ğŸš€ Project | Auth Module (with Redis)
date: 2024-10-09 00:00:00 +0800
toc: true
pin: false
published: true
categories: [PROJECT, NEXUS]
tags: [nest.js, next.js]
image: https://github.com/user-attachments/assets/2eba227c-8cb5-49fd-a564-f23b82d156f5
---

<br>

> ## Auth Module

<br>

---

1. Interface JwtPayload ë¡œ Payloadë¥¼ ì •ì˜í•˜ì—¬ Stratgyì— êµ¬í˜„ í›„ `@nestjs/passport`ì˜ `PassportStrategy`ë¥¼ ìƒì† í›„ ì •ì˜
2. JwtAuthGuardë¥¼ í†µí•´ ìƒì†ë°›ì€ í›„ ë‹¤ë¥¸ ëª¨ë“ˆ(Controller)ì—ì„œ ì‚¬ìš© (`@UseGuards(JwtAuthGuard)`)
3. HTTP ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ JWT ì¸ì¦ì„ ìˆ˜í–‰í•˜ê³ , ì¸ì¦ ê²°ê³¼ì— ë”°ë¼ ìš”ì²­ì„ í—ˆìš©í•˜ê±°ë‚˜ ê±°ë¶€í•˜ëŠ” ì—­í• 

---

<br>

### JwtGuard

JWT í† í°ì„ ê¸°ë°˜ìœ¼ë¡œ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ê°€ë“œ. ì¦‰, ì‚¬ìš©ìê°€ ìš”ì²­í•  ë•Œ JWT í† í°ì˜ ìœ íš¨ì„±ì„ í™•ì¸í•˜ê³ , ì¸ì¦ì´ ì„±ê³µí•˜ë©´ ìš”ì²­ì„ í†µê³¼

```typescript
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
```

#### JwtStrategy

ìš”ì²­ì—ì„œ JWT í† í°ì„ ì¶”ì¶œí•˜ê³ , ë¹„ë°€í‚¤ë¡œ ì„œëª…ëœ í† í°ì„ ê²€ì¦. ê²€ì¦ëœ í† í°ì˜ **Payload**ë¥¼ ë°˜í™˜

jwtStrategy í´ë˜ìŠ¤ëŠ” PassportStrategyë¥¼ ìƒì†ë°›ì•„ JWT í† í°ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê³ , ìœ íš¨í•œ ê²½ìš° í•´ë‹¹ í† í°ì˜ í˜ì´ë¡œë“œë¥¼ ë°˜í™˜

```typescript
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { Strategy, ExtractJwt } from 'passport-jwt';
import JwtPayload from '../interface/jwt-payload.interface';

@Injectable()
export class jwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: process.env.JWT_SECRET,
    });
  }

  async validate(payload: JwtPayload) {
    return payload; // JWT í˜ì´ë¡œë“œë¥¼ ë°˜í™˜
  }
}
```

#### JwtPayload

JWT í† í°ì˜ í˜ì´ë¡œë“œ êµ¬ì¡°ë¥¼ ì •ì˜í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤. í† í°ì— í¬í•¨ë  ì‚¬ìš©ì ì •ë³´(`userId`, `email`)ì˜ íƒ€ì…ì„ ëª…ì‹œí•˜ì—¬ íƒ€ì… ì•ˆì „ì„±ì„ ì œê³µ

```typescript
import { User } from '../../user/entites/user.entity';

interface JwtPayload {
  sub: User['userId'];
  email: User['email'];
}

export default JwtPayload;
```


<br>

---

<br>

### LocalGuard

ë¡œì»¬ ì „ëµ(Local Login)ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ê°€ë“œ. ì¦‰, ì‚¬ìš©ìê°€ ì…ë ¥í•œ ìê²© ì¦ëª…(ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸)ì„ í™•ì¸í•˜ì—¬ ì¸ì¦ì„ ìˆ˜í–‰

```typescript
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class LocalAuthGuard extends AuthGuard('local') {}
```

#### LocalStrategy

ì‚¬ìš©ìì˜ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìœ íš¨ì„±ì„ í™•ì¸í•˜ê³ , ì¸ì¦ì— ì„±ê³µí•œ ê²½ìš° ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜

```typescript
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { Strategy } from 'passport-local';
import { AuthService } from '../auth.service';
import { LoginDto } from '../dto/login.dto';
import { User } from '../../user/entites/user.entity';

@Injectable()
export class LocalStrategy extends PassportStrategy(Strategy) {
  constructor(private readonly authService: AuthService) {
    super({ usernameField: 'email' });
  }

  async validate(email: string, password: string): Promise<Partial<User>> {
    const loginDto = new LoginDto();
    loginDto.email = email;
    loginDto.password = password;

    const user = await this.authService.validateUser(loginDto);

    if (!user) {
      throw new UnauthorizedException('Invalid credentials');
    }
    return user;
  }
}
```


<br>


> ## RefreshToken connection with Redis

RefreshToken : ì¼ë°˜ì ìœ¼ë¡œ `7d` ì£¼ê¸°ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©° ë³„ë„ì˜ login process ì—†ì´ ì‚¬ìš©ìì˜ ê²½í—˜ì„ í–¥ìƒì‹œì¼œì¤€ë‹¤.
ê·¸ëŸ¬ë©´ RefreshTokenì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë§Œë“¤ê³  ê´€ë¦¬í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ? ê·¸ë ‡ì§€ë§Œ ìš°ì„  Redisì˜ ì¥ì ì„ ì•Œì•„ë³´ì.

[https://jng-su.github.io/posts/nexus(5)/](https://jng-su.github.io/posts/nexus(5)/)

1. `TTL (Time-To-Live)` ì„¤ì • ê°€ëŠ¥í•˜ì—¬ í°ì˜ ë§Œë£Œì¼ê³¼ ë˜‘ê°™ì´ ë§ì¶°ë‘ì–´ ê´€ë¦¬í•˜ë©´ í† í°ì´ ë§Œë£Œë˜ë©´ Redisì—ì„œë„ í† í°ì´ ì‚­ì œë˜ë„ë¡ í•˜ì—¬ ë¦¬ì†ŒìŠ¤ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.
2. í˜„ì¬ ì—‘ì„¸ìŠ¤ í† í° ë§Œë£Œì‹œê°„ì€ `60s` ì´ë¯€ë¡œ ìƒˆë¡­ê²Œ ê°±ì‹ í•˜ê¸° ìœ„í•´ RefreshTokenì´ í•„ìš”í•˜ë‹¤. ê·¸ë ‡ë‹´... í˜¸ì¶œì˜ ë¹ˆë„ê°€ ë§ì•„ì§€ê³  Databaseë¥¼ ì¡°íšŒí•˜ëŠ” ê²ƒ ë³´ë‹¤ `In-Memory`ì— ì €ì¥í•´ë‘ë©´ ì†ë„ê°€ ë¹ ë¥´ê³  Token ReIssue ë¡œì§ì˜ ë³‘ëª©í˜„ìƒì„ ì¤„ì—¬ì¤€ë‹¤.
3. ë‹¨, RedisëŠ” íœ˜ë°œì„± ë©”ëª¨ë¦¬ì´ê¸°ì— ì „ì›ì´ ëŠì–´ì§€ë©´ ë°ì´í„°ê°€ ì—†ì–´ì§„ë‹¤. RefreshToken ë§Œì„ ìœ„í•œ Redis ë°ì´í„°ëŠ” ì´ë“ë³´ë‹¤ ì†ì‹¤ì´ ë§ì„ ìˆ˜ ìˆë‹¤ê³  ìƒê°í•œë‹¤. 


### Redis Module

Auth Moduleë¥¼ ì œì™¸í•œ ë‹¤ë¥¸ Moduleì—ì„œ ìì£¼ ì‚¬ìš©í•  ê±° ê°™ìœ¼ë‹ˆ ëª¨ë“ˆí™” ì‹œì¼œë‘”ë‹¤. 

<br>

```shell
yarn add @nestjs-modules/ioredis ioredis
```

```typescript
import { Module } from '@nestjs/common';
import { RedisModule as NestjsRedisModule } from '@nestjs-modules/ioredis';
import { ConfigModule, ConfigService } from '@nestjs/config';

@Module({
  imports: [
    NestjsRedisModule.forRootAsync({
      imports: [ConfigModule],
      useFactory: (configService: ConfigService) => ({
        type: 'single',
        url: configService.get<string>('REDIS_URL'),
      }),
      inject: [ConfigService],
    }),
  ],
  exports: [NestjsRedisModule],
})
export class RedisModule {}
```

<br>

#### auth.service.ts

```typescript
 async login(dto: LoginDto) {
    const user = await this.validateUser(dto);
    const payload: JwtPayload = {
      sub: user.userId,
      email: user.email,
    };

    const accessToken = this.jwtService.sign(payload, {
      secret: process.env.JWT_SECRET,
      expiresIn: '60s',
    });

    const refreshToken = this.jwtService.sign(payload, {
      secret: process.env.JWT_SECRET,
      expiresIn: '7d',
    });

    const refreshTokenKey = `RefreshToken:${user.email}`;

    const existingToken = await this.redis.get(refreshTokenKey);
    if (existingToken) {
      await this.redis.del(refreshTokenKey);
    }

    await this.redis.set(refreshTokenKey, refreshToken, 'EX', 7 * 24 * 60 * 60);

    return {
      access_token: accessToken,
      refresh_token: refreshToken,
    };
  }
```

ë¡œê·¸ì¸ ì‹œ í´ë¼ì´ì–¸íŠ¸ì— AccessTokenê³¼ RefreshTokenì„ ì „ë‹¬í•œë‹¤. RefreshTokenì€ Redisì—ì„œ ë³„ë„ ê´€ë¦¬í•œë‹¤.

- `this.redis.get` : Redisì—ì„œ íŠ¹ì • í‚¤ì— í•´ë‹¹í•˜ëŠ” ê°’ì„ ì¡°íšŒí•˜ëŠ” ë° ì‚¬ìš©
    - ì¤‘ë³µì„ ì œê±°í•˜ê³  ë§Œì•½ì—, RefreshToken ë§Œë£Œ ì „ì— ReLogin í•  ê²½ìš° RefreshTokenì„ ê°±ì‹ í•˜ëŠ” ì—­í• ì„ í•œë‹¤.
- `this.redis.set` : Redisì— íŠ¹ì • í‚¤ì— ëŒ€í•œ ê°’ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‚¬ìš©
    - `refershTokenKey` : RefreshTokenì˜ í‚¤ë¥¼ ì§€ì •í•˜ê³  Redisì˜ ê·œì¹™(?)ì— ì˜í•´ **ê³„ì¸µì **ìœ¼ë¡œ í‘œí˜„í•˜ê¸° ìœ„í•¨.
    - `refreshToken` : Valueê°’ ì €ì¥
    - `EX` : expiresIn (ì´ˆ ë‹¨ìœ„, 7ì¼)


<br>

> ## Docker Test

- docker-compose.yml

```yml
  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
```

- backendì— depends_onì— `redis`ë¥¼ ì¶”ê°€í•´ì•¼í•¨
- REDIS_URLë¥¼ `.env.development`ì— ì¶”ê°€í•´ì•¼í•¨

<br>

```shell
docker-compose up --build
```

<br>

#### Connect Redis

```shell
docker exec -it <redis-name> redis-cli
```

![img](https://github.com/user-attachments/assets/df8b3c7e-106a-4377-91fd-803ca8e887cd){: width=100% height=100% .normal}

#### Connect Database

```shell
docker exec -it <database-name> mysql -u <user-name> -p
```

![img](https://github.com/user-attachments/assets/4cec6bb3-d472-49cf-8b49-1db124c9ae3f){: width=100% height=100%.normal}
