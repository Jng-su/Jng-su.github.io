---
title: ğŸš€ Project | Backend Authentication with docker [2]
date: 2024-10-07 00:00:00 +0800
toc: true
pin: false
published: true
categories: [PROJECT, NEXUS]
tags: [nest.js, next.js]
image: https://github.com/user-attachments/assets/2eba227c-8cb5-49fd-a564-f23b82d156f5
---

<br>

> ğŸ‘€ docker, user Authentication Test
{: .prompt-tip }

<br>

> ## Purpose of the project

'ì‚¬ìš©ì(user)'ê°€ 'ìƒí’ˆ(product)'ì„ ë“±ë¡í•˜ëŠ” ê°„ë‹¨í•œ ì–´í”Œë¦¬ì¼€ì´ì…˜ 

<br>

```shell
yarn add class-validator class-transformer nestjs-pino pino-http
```

<br>

- `class-validator` : TypeScript ë° JavaScript ê°ì²´ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê¸° ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬, DTO(Data Transfer Object)ë¥¼ ì‚¬ìš©í•  ë•Œ, ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë„ë¡ ì—¬ëŸ¬ ë°ì½”ë ˆì´í„°ë¥¼ ì œê³µ
- `class-transformer` : TypeScript ë° JavaScript ê°ì²´ì˜ ë³€í™˜ì„ ë„ì™€ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬, ê°ì²´ë¥¼ íŠ¹ì • í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³€í™˜í•˜ê±°ë‚˜ í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‹¨ìˆœí•œ ê°ì²´ë¡œ ë³€í™˜í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤€ë‹¤. class-validatorì™€ í•¨ê»˜ ì‚¬ìš©ë˜ì–´ DTOì˜ ë³€í™˜ ë° ê²€ì¦ì„ í•¨ê»˜ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- `nestjs-pino` : NestJSì—ì„œ Pino ë¡œê±°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ëª¨ë“ˆ, PinoëŠ” ë†’ì€ ì„±ëŠ¥ê³¼ êµ¬ì¡°í™”ëœ ë¡œê·¸ë¥¼ ì œê³µí•˜ëŠ” ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ, ê°„ë‹¨í•˜ê³  ë¹ ë¥¸ ë¡œê¹…ì„ ê°€ëŠ¥
- `pino-http` : HTTP ìš”ì²­ ë° ì‘ë‹µì„ ìœ„í•œ Pino ë¡œê¹… ë¯¸ë“¤ì›¨ì–´ì…ë‹ˆë‹¤. Express.jsì™€ ê°™ì€ HTTP ì„œë²„ì™€ í•¨ê»˜ ì‚¬ìš©ë˜ë©°, ê° ìš”ì²­ì˜ ë¡œê·¸ë¥¼ ìë™ìœ¼ë¡œ ê¸°ë¡í•  ìˆ˜ ìˆë„ë¡ í•´ì¤ë‹ˆë‹¤.

<br>

```shell
docker-compose up --build
```

<br>

### Product API

```shell
nest generate resource product --no-spec
```

<br>

#### main.ts

```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { Logger } from 'nestjs-pino';
import { ValidationPipe } from '@nestjs/common';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  const PORT = process.env.PORT;

  app.useLogger(app.get(Logger));
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,                       // DTOì— ì •ì˜ë˜ì§€ ì•Šì€ ì†ì„±ì€ ìë™ìœ¼ë¡œ ì œê±°
      forbidNonWhitelisted: true,            // í—ˆìš©ë˜ì§€ ì•Šì€ ì†ì„±ì´ ì „ë‹¬ë˜ë©´ ì˜ˆì™¸ ë°œìƒ
      transformOptions: {                    // íƒ€ì… ë³€í™˜ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬
        enableImplicitConversion: true,
      },
    }),
  );
  app.setGlobalPrefix('api');

  await app.listen(PORT, () => {
    console.log(
      `ğŸš€ Running API in Mode ${process.env.NODE_ENV} on Port : ${PORT}`,
    );
  });
}
bootstrap();
```

- `Logger` : Pino ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ í˜„ í”„ë¡œì íŠ¸ì— ë°œìƒí•˜ëŠ” ëª¨ë“  ë¡œê·¸ê°€ pino í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ë¨
    ![img](https://github.com/user-attachments/assets/b8c7ec5d-c4a6-4a60-bc08-acdd0f0e1216)
- `VaclidationPipe` : ìœ íš¨ì„± ê²€ì‚¬ íŒŒì´í”„ë¡œ DTOì™€ ê°™ì€ ê°ì²´ì˜ ìœ íš¨ì„±ì„ íŒë‹¨í•¨.
    - `whitelist` : DTOì— ì •ì˜ë˜ì§€ ì•Šì€ ì†ì„±ì€ ìë™ìœ¼ë¡œ ì œê±°
    - `forbidNonWhitelisted` : í´ë¼ì´ì–¸íŠ¸ê°€ í—ˆìš©ë˜ì§€ ì•Šì€ ì†ì„±ì„ ë³´ë‚¼ ê²½ìš° ì—ëŸ¬ë¥¼ ë°œìƒ
    - `transformOptions` : ë¬¸ìì—´ë¡œ ì „ë‹¬ëœ ìˆ«ìë¥¼ ìˆ«ì íƒ€ì…ìœ¼ë¡œ ìë™ ë³€í™˜

<br>

#### app.module.ts

```typescript
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ProductModule } from './product/product.module';
import { Product } from './product/entities/product.entity';
import { LoggerModule } from 'nestjs-pino';

@Module({
  imports: [
    LoggerModule.forRoot(),                         // pino log module
    TypeOrmModule.forRoot({                         // typeorm module
      type: 'mysql',
      host: 'database',
      port: Number(process.env.MYSQL_TCP_PORT),
      username: process.env.MYSQL_USER,
      password: process.env.MYSQL_PASSWORD,
      database: process.env.MYSQL_DATABASE,
      synchronize: true,
      entities: [Product],
    }),
    ProductModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {
  constructor() {
    console.log(
      `ğŸš€ Running Database Login as MySQL User : ${process.env.MYSQL_USER}`,
    );
  }
}
```

- `synchronize`
    - development : trueë¥¼ ì‚¬ìš©í•˜ë©´ ì½”ë“œì—ì„œ entity ë³€ê²½í•  ë•Œë§ˆë‹¤ ë°ì´í„°ë² ì´ìŠ¤ì— ìë™ìœ¼ë¡œ ë°˜ì˜ ë§¤ë²ˆ ìˆ˜ë™ìœ¼ë¡œ í…Œì´ë¸”ì„ ìˆ˜ì •í•  í•„ìš”ê°€ ì—†ë‹¤.
    - production : ì˜ˆê¸°ì¹˜ ì•Šì€ ë°ì´í„° ì†ì‹¤ì´ë‚˜ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, falseë¡œ ì„¤ì •í•˜ê³  Migration ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•ˆì „


<br>

#### product.module.ts

```typescript
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Product } from './entities/product.entity';
import { ProductService } from './product.service';
import { ProductController } from './product.controller';

@Module({
  imports: [TypeOrmModule.forFeature([Product])],           // â­ï¸
  controllers: [ProductController],
  providers: [ProductService],
})
export class ProductModule {}
```

<br>

#### dto

- create-product.dto.ts

  ```typescript
  import { IsString, IsNumber } from 'class-validator';

  export class CreateProductDto {
    @IsString()
    name: string;

    @IsNumber()
    price: number;
  }
  ```

<br>

- update-product.dto.ts

  ```typescript
  import { PartialType } from '@nestjs/mapped-types';
  import { CreateProductDto } from './create-product.dto';

  export class UpdateProductDto extends PartialType(CreateProductDto) {}
  ```

    - `PartialType` : CreateProductDtoì˜ ëª¨ë“  í•„ë“œë¥¼ ì„ íƒì (Nullable)ìœ¼ë¡œ ë§Œë“¤ê³  UpdateProductDtoëŠ” ì œí’ˆì„ ì—…ë°ì´íŠ¸í•  ë•Œ 'ì¼ë¶€ í•„ë“œ'ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.

<br>

### User and Auth API

<br>

- **User** : ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì£¼ë¡œ ë‹¤ë£¬ë‹¤. ì‚¬ìš©ì ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬ ë“±
    - `/users` : ëª¨ë“  ì‚¬ìš©ì ëª©ë¡ì„ ì¡°íšŒ
	- `/users/:id` : íŠ¹ì • ì‚¬ìš©ìì˜ ì •ë³´ ì¡°íšŒ
	- `/users/update` : ì‚¬ìš©ìì˜ ì •ë³´ ìˆ˜ì •
- **Auth** : ì‚¬ìš©ìì˜ ì¸ì¦ì„ ì£¼ë¡œ ë‹¤ë£¬ë‹¤. ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ, í† í° ë°œê¸‰, í† í° ê²€ì¦ ë“±
    - `/auth/login` : ì‚¬ìš©ì ë¡œê·¸ì¸ ì²˜ë¦¬
	- `/auth/register` : ìƒˆë¡œìš´ ì‚¬ìš©ì íšŒì›ê°€ì…
	- `/auth/refresh` : í† í° ê°±ì‹ 
	- `/auth/logout` : ë¡œê·¸ì•„ì›ƒ

<br>

```shell
nest g resource user --no-spec
nest g resource auth --no-spec
```

<br>

```shell
yarn add @nestjs/passport passport passport-local @nestjs/jwt passport-jwt bcrypt
yarn add -D @types/bcrypt
```

<br>

#### Auth

- auth.service.ts

    - Register : íšŒì›ê°€ì…ì€ `username` ì¤‘ë³µ ì—¬ë¶€ë§Œ íŒë‹¨í•˜ì—¬ í•´ì‹œí™”ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œë‹¤.

        ```typescript
        async register(username: string, password: string): Promise<UserEntity> {
            const existingUser = await this.userRepository.findOneBy({ username });

            if (existingUser) {
            throw new BadRequestException('User already exists');
            }

            const hashedPassword = await bcrypt.hash(password, 10);
            return this.userRepository.save({
            username,
            password: hashedPassword,
            });
        ```

    <br>

    - Login

        - controller

            ```typescript
            @UseGuards(LocalAuthGuard)
            @Post('login')
            async login(@Request() req) {
                return this.authService.login(req.user);
            }
            ```

            - `UseGuards` : íŠ¹ì • ìš”ì²­ì´ í•¸ë“¤ëŸ¬ì— ë„ë‹¬í•˜ê¸° ì „ì— ì¸ì¦ ë˜ëŠ” ê¶Œí•œ ê²€ì‚¬ë¥¼ ìˆ˜í–‰ (`true`/`false`)

            <br>

        - guard/local-auth.guard.ts

            ```typescript
            import { Injectable } from '@nestjs/common';
            import { AuthGuard } from '@nestjs/passport';

            @Injectable()
            export class LocalAuthGuard extends AuthGuard('local') {}
            ```

            - `LocalAuthGuard` : Passportì˜ **ì „ëµ(Strategy)**ì„ í˜¸ì¶œí•˜ëŠ” ì—­í• . ì—¬ê¸°ì„œì˜ `local` passport strategyì€ LocalAuthGuardê°€ ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ LocalStrategyë¥¼ í˜¸ì¶œí•œë‹¤. 

            <br>

        - strategy/local.strategy.ts

            ```typescript
            import { Injectable, UnauthorizedException } from '@nestjs/common';
            import { PassportStrategy } from '@nestjs/passport';
            import { Strategy } from 'passport-local';
            import { AuthService } from '../auth.service';

            @Injectable()
            export class LocalStrategy extends PassportStrategy(Strategy) {
            constructor(private readonly authService: AuthService) {
                super();
            }

            async validate(username: string, password: string): Promise<any> {
                const user = this.authService.validateUser(username, password);

                if (!user) {
                    throw new UnauthorizedException();
                }
                return user;
                }
            }
            ```

            - `LocalStrategy`: Passportì˜ PassportStrategyë¥¼ í™•ì¥í•˜ì—¬ ì‚¬ìš©ìì˜ ì¸ì¦ì„ ì²˜ë¦¬í•œë‹¤. `validate` ë©”ì„œë“œëŠ” ì…ë ¥ëœ `user` ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìë¥¼ ê²€ì¦í•˜ë©°, ì¸ì¦ì´ ì‹¤íŒ¨í•  ê²½ìš° `UnauthorizedException`ì„ ë˜ì§„ë‹¤. ì„±ê³µì ìœ¼ë¡œ ì¸ì¦ë˜ë©´ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜

            <br>

        - service/auth.service.ts

            ```typescript
            async validateUser(
                username: string,
                password: string,
            ): Promise<Partial<UserEntity>> {
                const user = await this.userRepository.findOneBy({ username });
                if (!user) {
                    throw new BadRequestException('User does not exist');
                }
                const isPasswordValid = await bcrypt.compare(password, user.password);
                if (!isPasswordValid) {
                    throw new BadRequestException('Invalid password');
                }

                const { password: _, ...result } = user;
                return result;
            }

            async login(user: any) {
                const payload = {
                    username: user.username,
                    sub: user.userId,
                };

                return {
                    access_token: this.jwtService.sign(payload, {
                        secret: process.env.JWT_SECRET,
                        expiresIn: '60s',
                    }),
                };
            }
            ```

            - `validate` : `username`ê³¼ `password`ë¥¼ ê²€ì¦í•˜ê³  **`password`ë¥¼ ì œì™¸í•œ `user`ì •ë³´**ë¥¼ ë°˜í™˜í•œë‹¤.
                - controllerë¥¼ ë³´ë©´ `@Body`ê°€ ì•„ë‹Œ `@Request`ë¥¼ ë°›ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
            
            <br>

            ---

            <br>

            ì•„ë˜ ë‚´ìš©ì€ "Prodcut ëŠ” íšŒì›ê°€ì…ëœ user ë“¤ë§Œ ì ‘ê·¼ ê°€ëŠ¥" í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— `@UseGuard(@JwtAuthGuard)`ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•¨

            <br>

            - jwt.strategy.ts

            ```typescript
            import { Injectable } from '@nestjs/common';
            import { PassportStrategy } from '@nestjs/passport';
            import { Strategy, ExtractJwt } from 'passport-jwt';

            @Injectable()
            export class jwtStrategy extends PassportStrategy(Strategy) {
            constructor() {
                super({
                    jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
                    ignoreExpiration: false,
                    secretOrKey: process.env.JWT_SECRET,
                });
            }

                async validate(payload: any) {
                    return payload;
                }
            }
            ```

            - `injectable()` : NestJSì˜ ì˜ì¡´ì„± ì£¼ì… ì‹œìŠ¤í…œì— ì˜í•´ ì´ í´ë˜ìŠ¤ê°€ ì¸ìŠ¤í„´ìŠ¤í™”ë  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë°ì½”ë ˆì´í„°
                - ì´ë¥¼ í†µí•´ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë‚˜ ëª¨ë“ˆì—ì„œ jwtStrategyë¥¼ ì£¼ì…í•˜ì—¬ ì‚¬ìš©ê°€ëŠ¥
            - `jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken()` : HTTP Authorization í—¤ë”ì—ì„œ Bearer í† í° í˜•íƒœë¡œ JWTë¥¼ ì¶”ì¶œ
            - `ignoreExpiration: false` : JWTì˜ ë§Œë£Œë¥¼ ë¬´ì‹œí• ì§€ ì—¬ë¶€ë¥¼ ì„¤ì •í•œë‹¤. falseë¡œ ì„¤ì •í•˜ë©´ ë§Œë£Œëœ JWTëŠ” ìœ íš¨í•˜ì§€ ì•Šë‹¤ê³  íŒë‹¨
            - `secretOrKey: process.env.JWT_SECRET` : JWT ì„œëª…ì„ ê²€ì¦í•  ë¹„ë°€ í‚¤ë¥¼ ì„¤ì •

            <br>

            - jwt.guard.ts

            ```typescript
            import { Injectable } from '@nestjs/common';
            import { AuthGuard } from '@nestjs/passport';

            @Injectable()
            export class JwtAuthGuard extends AuthGuard('jwt') {}
            ```


            <br>

            - product.controller.ts

            ```typescript
            @Post()
            @UseGuards(JwtAuthGuard)
            create(@Body() createProductDto: CreateProductDto) {
                return this.productService.create(createProductDto);
            }
            ```


            <br>

            ---

            <br>

            - auth.module.ts

            ```typescript
            @Module({
            imports: [
                // User Entity ì‚¬ìš©í•´ í•˜ë¯€ë¡œ!
                TypeOrmModule.forFeature([UserEntity]),
                // Passport ëª¨ë“ˆì„ ê°€ì ¸ì™€ ì¸ì¦ ê´€ë ¨ ê¸°ëŠ¥ì„ ì‚¬ìš©
                PassportModule,
                // JWT ëª¨ë“ˆì„ ë“±ë¡, ì¶”ê°€ ë“±ë¡ ê°€ëŠ¥
                JwtModule.register({}),
            ],
            controllers: [AuthController],
            providers: [AuthService, LocalStrategy, jwtStrategy],
            // jwtStrategyë¥¼ product ëª¨ë“ˆì—ì„œ ì‚¬ìš©í•´ í•˜ë¯€ë¡œ!
            exports: [jwtStrategy],
            })
            export class AuthModule {}
            ```