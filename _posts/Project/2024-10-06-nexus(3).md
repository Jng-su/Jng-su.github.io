---
title: ğŸš€ Project | Backend Authentication with docker [1]
date: 2024-10-06 00:00:00 +0800
toc: true
pin: false
published: true
categories: [PROJECT, NEXUS]
tags: [nest.js, next.js]
image: https://github.com/user-attachments/assets/2eba227c-8cb5-49fd-a564-f23b82d156f5
---

<br>

> ğŸ‘€ docker, user Authentication Test
{: .prompt-tip }

<br>

> ## Docker

DockerëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì»¨í…Œì´ë„ˆë¼ëŠ” ë…ë¦½ëœ í™˜ê²½ì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” í”Œë«í¼ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ê·¸ ì˜ì¡´ì„±ì„ íŒ¨í‚¤ì§•í•˜ì—¬ ì¼ê´€ë˜ê²Œ ë°°í¬í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- í™˜ê²½ ì¼ê´€ì„±: DockerëŠ” ê°œë°œ, í…ŒìŠ¤íŠ¸, ë°°í¬ í™˜ê²½ì„ ë™ì¼í•˜ê²Œ ìœ ì§€ì‹œì¼œì¤€ë‹¤.
- ê²©ë¦¬ëœ ì‹¤í–‰: ì—¬ëŸ¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë™ì¼í•œ ì‹œìŠ¤í…œì—ì„œ ì„œë¡œ ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  ì‹¤í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Redis, Database, Server)
- ìë™í™” ë° íš¨ìœ¨ì„±: CI/CDì™€ í†µí•©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬ë¥¼ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

> ## Docker Setup

<br>

{% include embed/youtube.html id='a0B6MdC75z0' %}

<br>

### 1. Dockerfile Setup

<br>

- Dockerfile (development)

  ```Dockerfile
  FROM node:21

  WORKDIR /usr/src/app

  COPY . .

  RUN yarn install

  EXPOSE 3000

  CMD ["yarn", "start:dev"]
  ```

  <br>

- Dockerfile.prod (production)

  ```Dockerfile
  FROM node:21

  WORKDIR /usr/src/app

  COPY . .

  RUN yarn install

  RUN yarn run build

  RUN rm -rf ./src

  EXPOSE 3001

  CMD ["yarn", "start:prod"]
  ```

<br>

`Dockerfile` ì€ ë¦¬ë¡œë”© ë“± ê°œë°œì— í¸ë¦¬í•œ ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ê³  ì†ŒìŠ¤ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•œë‹¤. `Dockerfile.prod` ëŠ” ì½”ë“œë¥¼ ë¹Œë“œí•œ í›„ì— ìµœì í™”í•œê³  ë¹Œë“œ í›„ ì‚­ì œí•˜ì—¬ ì„±ëŠ¥ê³¼ ë³´ì•ˆì— ì¤‘ì ì„ ë‘”ë‹¤.

  - `Dockerfile` : ì†ŒìŠ¤ ì½”ë“œê°€ ê·¸ëŒ€ë¡œ ë³µì‚¬, ë¹Œë“œ ê³¼ì • ì—†ì´ ì‹¤í–‰
  - `Dockerfile.prod` : ì½”ë“œê°€ ë¹Œë“œë˜ê³  í•„ìš”í•˜ì§€ ì•Šì€ ì†ŒìŠ¤ ì½”ë“œ ì‚­ì œ

<br>


### 2. docker-compose.yml Setup

- docker-compose.yml

  [https://hub.docker.com/mysql](https://hub.docker.com/_/mysql)

  ```yml
    # server
    api:
      build:
        context: .
        dockerfile: Dockerfile
      env_file:
        - .env.development
      ports:
        - 3000:3000
      volumes:
        - ./src:/usr/src/app/src
      depends_on:
        database:
          condition: service_healthy

    # database
    database:           # â­ï¸ Database Host Name â­ï¸
      image: mysql
      ports:
        - '3306:3306'   # â­ï¸ Database Port Number â­ï¸
      healthcheck:
        test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
        interval: 10s
        timeout: 5s
        retries: 5
      environment:
        - MYSQL_ROOT_PASSWORD=root_password_123
        - MYSQL_DATABASE=database_name            # â­ï¸ Database name â­ï¸
        - MYSQL_USER=database_user                # â­ï¸ Database user name â­ï¸
        - MYSQL_PASSWORD=database_password        # â­ï¸ Database user password â­ï¸
        - MYSQL_TCP_PORT=3306
  ```

<br>

- docker-compose.prod.yml

  ```yml
    # server
    api_prod:
      build:
        context: .
        dockerfile: Dockerfile.prod
      ports:
        - 3001:3001
      environment:
        - PORT=3001
        - NODE_ENV=production
      volumes:
        - ./src:/usr/src/app/src
  ```

  ìœ„ ë‚´ìš©ì€ ë°°í¬í•  ë•Œ ìˆ˜ì •í•˜ë§ˆ ğŸ¦›

<br>

- Development Mode

  ```shell
  docker-compose up --build
  ```

  ![img](https://github.com/user-attachments/assets/0442b38b-03a0-438c-bc9f-df87cef02277)

<br>

- Production Mode

  ```shell
  docker-compose -f docker-compose.prod.yml up --build
  ```
  ì„œë¹„ìŠ¤ì˜ ë¡œê·¸ê°€ í„°ë¯¸ë„ì— ì¶œë ¥, ì„œë¹„ìŠ¤ ìƒíƒœ ì‹¤ì‹œê°„ í™•ì¸ ê°€ëŠ¥

  ```shell
  docker-compose -f docker-compose.prod.yml up --build -d
  ```
  ì„œë¹„ìŠ¤ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰, ë¡œê·¸ ì¶œë ¥ ì•ˆë¨, ë‹¤ë¥¸ ì‘ì—… í•˜ë©´ì„œ ì„œë¹„ìŠ¤ ìš´ì˜ ê°€ëŠ¥

  ![img](https://github.com/user-attachments/assets/05d4bdb9-b18d-440d-bd7f-07c10182dd05)


  ```shell
  yarn add @nestjs/typeorm typeorm mysql2
  ```

  ```typescript
  @Module({
    imports: [
      TypeOrmModule.forRoot({
        type: 'mysql',
        host: 'database',
        port: Number(process.env.MYSQL_TCP_PORT),
        username: process.env.MYSQL_USER,
        password: process.env.MYSQL_PASSWORD,
        database: process.env.MYSQL_DATABASE,
        entities: [],
        synchronize: true,
      }),
    ],
    controllers: [AppController],
    providers: [AppService],
  })
  export class AppModule {
    constructor() {
      console.log(
        `ğŸš€ Running Database Login as MySQL User : ${process.env.MYSQL_USER}`,
      );
    }
  }
  ```

  ```shell
  docker-compose up --build
  ```

  ![img](https://github.com/user-attachments/assets/2e216d2c-9b44-4770-aeb0-b0f55483f3f5)

<br>

### 3. ETC settings

<br>

- tsconfig.json

  ```json
    "watchOptions": {
      "watchFile": "dynamicPriorityPolling",
      "watchDirectory": "dynamicPriorityPolling",
      "excludeDirectories": ["**/node_modules/", "dist"]
    }
  ```

<br>

- .env.development

  ```
  PORT=3000
  NODE_ENV=development

  MYSQL_HOSTNAME=database
  MYSQL_ROOT_PASSWORD=root_password_123
  MYSQL_DATABASE=database_name
  MYSQL_USER=database_user
  MYSQL_PASSWORD=database_password
  MYSQL_TCP_PORT=3306
  ```

<br>

- .dockerignore

  ```
  node_modules
  test
  .gitignore
  .git
  .prettierrc
  Dockerfile
  README.md
  ```


<br>

- Docker commands : (ì°¸ê³ ìš©) ëŒ€ë¶€ë¶„ **`docker-compose up --build`** ì‚¬ìš©í•¨

  - Create docker image

    ```shell
    docker build -t [image_name]:[tag] .
    ```

  - Run docker image

    ```shell
    docker run -p 3000:3000 [image_name]:[tag]
    ```

    ë§Œì•½ í¬íŠ¸ê°€ ì‚¬ìš©ì¤‘ì´ë¼ëŠ” ì—ëŸ¬ê°€ ë‚˜ì˜¤ë©´ í¬íŠ¸ë²ˆí˜¸ë¥¼ ë°”ê¾¸ë©´ë¨ (~~ë‹¹ì—°í•œ ì†Œë¦¬~~) ë˜ëŠ” ì‚¬ìš©í•˜ê³  ìˆëŠ”ê±° ì£½ì´ë˜ê°€.

    ![img](https://github.com/user-attachments/assets/5d38e200-a286-4108-bbc5-f1c10fa443b0)

    ```shell
    docker run -p 8080:3000 [image_name]:[tag]
    ```

    ì´ ë°©ë²•ì€ **ë¡œì»¬ì—ì„œ `8080`ìœ¼ë¡œ ì ‘ê·¼**í•˜ë©´ ë„ì»¤ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ `3000`ë²ˆ ìœ¼ë¡œ ì „ë‹¬ë¨


  <br>

  - Remove docker image : ì°¸ê³ ë¡œ Docker Desktop ì—ì„œ ì‰½ê²Œ ê°€ëŠ¥

    ```shell
    docker ps -a
    docker stop [container_id]
    docker rm [container_id]
    docker rmi [image_name]:[tag]
    ```

  <br>

  - Create Dockerfile.prod image

    ```shell
    docker build -t [image_name]:[tag] -f Dockerfile.prod .
    ```

  - Run docker.prod image

    ```shell
    docker run -p 3000:3000 [image_name]:[tag]
    ```

<br>

### 4. Recap

<br>

1. dockerfile ìƒì„±
2. docker-compose.yml ìƒì„±
3. .env ë“±ê³¼ ê°™ì€ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
4. docker ì‹¤í–‰

```
docker-compose up --build
```

ì°¸ê³ ë¡œ node_modulesì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•˜ë©´ dockerê°€ ì‹¤í–‰ì¤‘ì¼ ê²½ìš° ë°˜ì˜ì´ ì•ˆë˜ê³  íŒŒì¼ ë³€ê²½ë§Œ ê°ì§€í•œë‹¤.

<br>

---

<br>

â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡ â¬‡

[https://github.com/Jng-su/nestjs-docker](https://github.com/Jng-su/nestjs-docker)

â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬† â¬†

<br>

---

<br>

